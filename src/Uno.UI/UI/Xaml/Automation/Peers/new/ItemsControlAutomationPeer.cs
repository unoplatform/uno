// <auto-generated>
#pragma warning disable 108 // new keyword hiding
#pragma warning disable 114 // new keyword hiding
using System;
using System.Collections.Generic;
using Microsoft.UI.Xaml.Automation;
using Microsoft.UI.Xaml.Automation.Provider;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Controls.Primitives;

namespace Microsoft.UI.Xaml.Automation.Peers;

public partial class ItemsControlAutomationPeer : FrameworkElementAutomationPeer, IItemContainerProvider
{
	private readonly Dictionary<object, ItemAutomationPeer> _itemPeers = new(Uno.ReferenceEqualityComparer<object>.Default);

	public ItemsControlAutomationPeer(ItemsControl owner) : base(owner)
	{
		ArgumentNullException.ThrowIfNull(owner);
	}

	protected override string GetClassNameCore() => "ItemsControl";

	protected override AutomationControlType GetAutomationControlTypeCore() => AutomationControlType.List;

	protected override List<AutomationPeer> GetChildrenCore()
	{
		if (Owner is not ItemsControl itemsControl)
		{
			return base.GetChildrenCore();
		}

		var children = new List<AutomationPeer>();
		var items = itemsControl.Items;
		for (var i = 0; i < items.Count; i++)
		{
			var peer = CreateItemAutomationPeer(items[i]);
			if (peer != null)
			{
				children.Add(peer);
			}
		}

		return children;
	}

	protected override void ClearItemAutomationPeerCache() => _itemPeers.Clear();

	public ItemAutomationPeer CreateItemAutomationPeer(object item)
		=> item == null ? null : _itemPeers.TryGetValue(item, out var peer) ? peer : AddItemAutomationPeer(item);

	protected virtual ItemAutomationPeer OnCreateItemAutomationPeer(object item) => new(item, this);

	private ItemAutomationPeer AddItemAutomationPeer(object item)
	{
		var peer = OnCreateItemAutomationPeer(item);
		if (peer != null)
		{
			_itemPeers[item] = peer;
		}

		return peer;
	}

	internal void EnsureItemRealized(ItemAutomationPeer peer)
	{
		if (Owner is not ItemsControl itemsControl)
		{
			return;
		}

		if (itemsControl.ContainerFromItem(peer.Item) != null)
		{
			return;
		}

		switch (itemsControl)
		{
			case ListViewBase listViewBase:
				listViewBase.ScrollIntoView(peer.Item);
				break;
			case ListBox listBox:
				listBox.ScrollIntoView(peer.Item);
				break;
			case ComboBox comboBox:
				comboBox.ScrollIntoView(peer.Item);
				break;
		}
	}

	public IRawElementProviderSimple FindItemByProperty(IRawElementProviderSimple startAfter, AutomationProperty automationProperty, object value)
	{
		if (Owner is not ItemsControl itemsControl)
		{
			return null;
		}

		var items = itemsControl.Items;
		var startPeer = startAfter?.AutomationPeer as ItemAutomationPeer;
		var startIndex = startPeer != null ? items.IndexOf(startPeer.Item) : -1;

		var property = AutomationHelper.ConvertPropertyToEnum(automationProperty);
		if (property == AutomationHelper.AutomationPropertyEnum.NotSupported)
		{
			return null;
		}

		for (var i = startIndex + 1; i < items.Count; i++)
		{
			var item = items[i];
			if (property == AutomationHelper.AutomationPropertyEnum.EmptyProperty || DoesItemMatch(item, property, value))
			{
				var peer = CreateItemAutomationPeer(item);
				if (peer != null)
				{
					return ProviderFromPeer(peer);
				}
			}
		}

		return null;
	}

	private bool DoesItemMatch(object item, AutomationHelper.AutomationPropertyEnum property, object value)
	{
		if (property == AutomationHelper.AutomationPropertyEnum.NameProperty)
		{
			var peer = CreateItemAutomationPeer(item);
			if (peer == null)
			{
				return false;
			}

			var requestedName = value?.ToString() ?? string.Empty;
			return string.Equals(peer.GetName(), requestedName, StringComparison.Ordinal);
		}

		if (property == AutomationHelper.AutomationPropertyEnum.IsSelectedProperty)
		{
			var desiredSelection = value switch
			{
				bool boolValue => (bool?)boolValue,
				bool? nullableBool => nullableBool,
				_ => null,
			};

			return desiredSelection.HasValue && IsItemSelected(item) == desiredSelection.Value;
		}

		return false;
	}

	private bool IsItemSelected(object item)
	{
		if (Owner is ListViewBase listViewBase)
		{
			var selectedItems = listViewBase.SelectedItems;
			if (selectedItems != null && selectedItems.Contains(item))
			{
				return true;
			}

			return ReferenceEquals(listViewBase.SelectedItem, item);
		}

		if (Owner is Selector selector)
		{
			return ReferenceEquals(selector.SelectedItem, item);
		}

		return false;
	}
}
