name: "Docs Update"
description: "Update external docs commit hashes to latest from default branches"

inputs:
  branch:
    description: 'base branch'
    required: true
    default: 'master'

outputs:
  has_changes:
    description: 'Whether changes were detected'
    value: ${{ steps.check_changes.outputs.has_changes }}

runs:
  using: "composite"
  steps:
    - name: Setup PowerShell
      shell: pwsh
      run: |
        Write-Host "Setting up environment for docs update..." -ForegroundColor Green

    - name: Update external docs commit hashes
      shell: pwsh
      run: |
        Write-Host "Updating external docs commit hashes..." -ForegroundColor Green
        
        $scriptPath = "doc/import_external_docs.ps1"
        
        if (-Not (Test-Path $scriptPath)) {
            Write-Error "Script not found: $scriptPath"
            exit 1
        }
        
        # Get the list of repositories from the script
        Write-Host "Getting repository list from $scriptPath..." -ForegroundColor Cyan
        $repos = & $scriptPath -ListRepos
        
        if (-not $repos -or $repos.Count -eq 0) {
            Write-Warning "No repositories found in $scriptPath"
            exit 0
        }
        
        Write-Host "Found $($repos.Count) repositories to update:" -ForegroundColor Green
        $repos | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }

        # Determine behavior based on the action input branch
        $branchInput = '${{ inputs.branch }}'
        $useReleaseBranches = $branchInput -like 'release/stable/*'

        if ($useReleaseBranches) {
            Write-Host "Running in release mode for '$branchInput' - will use each repo's latest 'release/stable/*' branch if available, otherwise its default branch." -ForegroundColor Cyan
        } else {
            Write-Host "Running in default mode for '$branchInput' - will use each repo's default branch." -ForegroundColor Cyan
        }
        
        # Read the current script content
        $content = Get-Content $scriptPath -Raw
        $updatedCount = 0
        
        foreach ($repo in $repos) {
            Write-Host "Processing $repo..." -ForegroundColor Cyan
            
            try {
                # First, get the repository info to find the default branch
                $repoInfoUrl = "https://api.github.com/repos/unoplatform/$repo"
                $repoInfo = Invoke-RestMethod -Uri $repoInfoUrl -Headers @{
                    "Accept" = "application/vnd.github.v3+json"
                    "User-Agent" = "Uno-Docs-Updater"
                }
                
                $defaultBranch = $repoInfo.default_branch
                Write-Host "  Default branch: $defaultBranch" -ForegroundColor Gray

                $targetBranch = $defaultBranch
                $branchDescription = $defaultBranch

                if ($useReleaseBranches) {
                    # Try to locate the latest release/stable/* branch for this repo
                    $branchesUrl = "https://api.github.com/repos/unoplatform/$repo/branches?per_page=100"

                    # Fetch all branches with pagination
                    $allBranches = @()
                    $nextUrl = $branchesUrl
                    do {
                        $response = Invoke-WebRequest -Uri $nextUrl -Headers @{
                            "Accept" = "application/vnd.github.v3+json"
                            "User-Agent" = "Uno-Docs-Updater"
                        }
                        $pageBranches = $response.Content | ConvertFrom-Json
                        $allBranches += $pageBranches

                        # Parse Link header for pagination
                        $linkHeader = $response.Headers["Link"]
                        $nextUrl = $null
                        if ($linkHeader) {
                            foreach ($link in $linkHeader -split ",") {
                                if ($link -match '<([^>]+)>;\s*rel="next"') {
                                    $nextUrl = $matches[1]
                                }
                            }
                        }
                    } while ($nextUrl)

                    $branches = $allBranches
                    $releaseBranches = @()
                    foreach ($b in @($branches)) {
                        $name = $b.name
                        if ($name -like 'release/stable/*') {
                            $suffix = $name.Substring('release/stable/'.Length)
                            try {
                                $version = [version]$suffix
                                $releaseBranches += [pscustomobject]@{ Name = $name; Version = $version }
                            } catch {
                                Write-Host "  Skipping branch '$name' – unable to parse version part '$suffix'." -ForegroundColor DarkYellow
                            }
                        }
                    }

                    if ($releaseBranches.Count -gt 0) {
                        $latestRelease = $releaseBranches | Sort-Object Version -Descending | Select-Object -First 1
                        $targetBranch = $latestRelease.Name
                        $branchDescription = $latestRelease.Name
                        Write-Host "  Using latest release branch: $targetBranch" -ForegroundColor Gray
                    } else {
                        Write-Host "  No 'release/stable/*' branches found – falling back to default branch '$defaultBranch'." -ForegroundColor DarkYellow
                    }
                }
                
                # Get the latest commit hash from the selected branch
                $commitUrl = "https://api.github.com/repos/unoplatform/$repo/commits/$targetBranch"
                $commitInfo = Invoke-RestMethod -Uri $commitUrl -Headers @{
                    "Accept" = "application/vnd.github.v3+json"
                    "User-Agent" = "Uno-Docs-Updater"
                }
                
                $latestHash = $commitInfo.sha
                Write-Host "  Latest commit on '$targetBranch': $latestHash" -ForegroundColor Gray
                
                # Update the hash in the script using regex
                # Match pattern: "repo-name" = @{ ref="<hash>" } [; dest=...] [anything-after]
                # We intentionally ignore any existing comment and always replace it with
                #   #latest $branchDescription commit
                $escapedRepo = [regex]::Escape($repo)
                $pattern = "`"$escapedRepo`"\s*=\s*@\{\s*ref\s*=\s*`"[a-f0-9]{40}`"\s*\}(\s*;\s*[^#]*)?.*"
                $comment = "latest $branchDescription commit"
                $replacement = "`"$repo`" = @{ ref=`"$latestHash`" }${1} #$comment"
                
                $newContent = $content -replace $pattern, $replacement
                
                if ($newContent -ne $content) {
                    $content = $newContent
                    $updatedCount++
                    Write-Host "  ✓ Updated $repo to $latestHash" -ForegroundColor Green
                } else {
                    Write-Host "  ⚠ No change for $repo (already up to date or pattern not matched)" -ForegroundColor Yellow
                }
            }
            catch {
                Write-Warning "Failed to process $repo : $_"
            }
        }
        
        # Write the updated content back to the file
        if ($updatedCount -gt 0) {
            Set-Content -Path $scriptPath -Value $content -NoNewline
            Write-Host "`n✓ Updated $updatedCount commit hash(es) in $scriptPath" -ForegroundColor Green
        } else {
            Write-Host "`n⚠ No updates were made" -ForegroundColor Yellow
        }
        
        # Show git diff for verification
        Write-Host "`nChanges made:" -ForegroundColor Cyan
        git diff $scriptPath

    - name: Check for changes
      id: check_changes
      shell: pwsh
      run: |
        $changes = git status --porcelain doc/import_external_docs.ps1
        if ($changes) {
            echo "has_changes=true" >> $env:GITHUB_OUTPUT
            Write-Host "Changes detected in import_external_docs.ps1" -ForegroundColor Green
        } else {
            echo "has_changes=false" >> $env:GITHUB_OUTPUT
            Write-Host "No changes detected in import_external_docs.ps1" -ForegroundColor Yellow
        }
